<html>
	<head>
		<title>Github Language Distribution On Earth</title>
		<link rel="stylesheet" type="text/css" href="./css/dist.css">
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>-->
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
		<script type="text/javascript" src="./js/dist.js"></script>
		<script type="text/javascript" src="./js/gapi.js"></script>
		<script>
			var map = null;
			var currentHeatMap = null;

			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					zoom: 2,
					center: {lat: 22.63929637837135, lng: -36.53190039062497},
					mapTypeId: google.maps.MapTypeId.SATELLITE
				});
			}

			function renderLang(lang){
				console.log('Rendering... ' + lang);

				var heatmap = new google.maps.visualization.HeatmapLayer({
					data: getDistByLang(lang),
					map: map,
					radius: 30
				});

				if (currentHeatMap != null)
					currentHeatMap.setMap(null);
				currentHeatMap = heatmap;
			}

			function gradient(heatmap){
				var _gradients = [
					'rgba(0, 255, 255, 0)',
					'rgba(0, 255, 255, 1)',
					'rgba(0, 191, 255, 1)',
					'rgba(0, 127, 255, 1)',
					'rgba(0, 63, 255, 1)',
					'rgba(0, 0, 255, 1)',
					'rgba(0, 0, 223, 1)',
					'rgba(0, 0, 191, 1)',
					'rgba(0, 0, 159, 1)',
					'rgba(0, 0, 127, 1)',
					'rgba(63, 0, 91, 1)',
					'rgba(127, 0, 63, 1)',
					'rgba(191, 0, 31, 1)',
					'rgba(255, 0, 0, 1)'
				]
				heatmap.set('gradient',heatmap.get('gradient') ? null : _gradients)
			}

			function makeGoogleCoord(coord){
				var density = coord[2];
				/*return new google.maps.visualization.WeightedLocation(
						coord[0],
						coord[1],
						density
					);*/
				return {
					location:new google.maps.LatLng(coord[0],coord[1]),
					weight: density
				}
				//return new google.maps.LatLng(coord[0],coord[1])
			}

			function getAllLangs(){
				return getDist().map((n) => n.lang._id);
			}

			function getDistByLang(lang){
				var allDist = getDist();
				var dist = allDist.filter((n) => n.lang._id==lang);
				if (dist.length==0){
					console.error('Unknown language : ',lang);
					return false;
				}

				return dist[0].coords.map(makeGoogleCoord);
			}

		// Add deferred loaded script
		$(document).ready(function(){
			// Load Google Map visualisation API
			console.log('Injecting Google Map API ...');
			var script = document.createElement('script');
			var url = "https://maps.googleapis.com/maps/api/js?key=";
			url += getAPIKey();
			url += "&libraries=visualization&callback=initMap";
			script.setAttribute('src',url);
			script.setAttribute('async','');
			script.setAttribute('defer','');
			document.head.appendChild(script);

			// Render list of available language selection
			var langs = getAllLangs();
			langs.forEach((n) => {
				var opt = $('<option value="'+n+'">'+n+'</option>');
				$('#panel-lang select').first().append(opt)
			})
		})
		</script>
	</head>
	<body>
		<div id="panel-lang">
			<select size="32" onchange="renderLang(this.value)"></select>
		</div>
		<div id="map"></div>
	</body>
</script>
